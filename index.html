<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Tool Stack</title>
    <style>
        /* --- RESET & GLOBAL FONTS --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Google Sans', 'Google Sans Text', 'Segoe UI', Helvetica, Arial, sans-serif;
        }

        body, html {
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
        }

        /* --- VIDEO BACKGROUND --- */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            background: #002d56;
        }
        
        .video-background iframe {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100vw;
            height: 56.25vw; 
            min-height: 100vh;
            min-width: 177.77vh;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 45, 86, 0.1) 0%, rgba(0, 45, 86, 0.4) 100%);
            z-index: -1;
        }

        /* --- NAVIGATION --- */
        nav {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 50px 60px; 
            color: white;
            flex-shrink: 0; 
            z-index: 10;
        }

        body.interacting nav { display: none !important; }

        .logo-img {
            height: 130px !important; 
            min-height: 130px !important;
            width: auto !important;
            display: block;
        }

        /* --- MAIN LAYOUT --- */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            flex-grow: 1; 
            color: white;
            padding: 0 10px;
            max-width: 100%; 
            margin: 0 auto;
            width: 100%;
            transition: all 0.5s ease;
        }

        body.interacting .container {
            display: flex;
            flex-direction: row; 
            align-items: flex-start; 
            justify-content: center; 
            padding: 20px 10px;
            gap: 15px;
        }

        h1 {
            font-size: 3.8rem;
            margin-bottom: 15px;
            font-weight: 300;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        p.subtitle {
            font-size: 1.6rem;
            margin-bottom: 40px; 
            opacity: 0.95;
            font-weight: 400;
            max-width: 700px;
            text-align: center;
        }

        body.interacting h1, body.interacting p.subtitle { display: none !important; }

        /* --- SIDEBAR PANEL --- */
        .sidebar-panel {
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            width: 280px; 
            height: 96vh;
            margin-top: 0; 
            margin-bottom: 0;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
        }

        body.interacting .sidebar-panel { display: flex; }

        .lenses-header, .artifact-header {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 0; 
            margin-bottom: 20px;
            opacity: 0.8;
            font-weight: 600;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
            color: white;
            text-align: left;
            width: 100%;
            white-space: nowrap;
        }

        .lens-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px; 
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            color: white;
        }

        .sidebar-panel .lens-card {
            padding: 15px;
            margin-bottom: 12px;
            text-align: left;
            align-items: flex-start;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .lens-card:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
        }

        .lens-card .card-type {
            font-size: 10px;
            font-weight: 700;
            color: #00D1FF;
            margin-bottom: 4px;
            text-transform: uppercase;
            display: none; 
        }

        .sidebar-panel .lens-card .card-type { display: block; }

        .lens-title { 
            font-weight: 500; 
            display: block; 
            line-height: 1.15;
        }

        .sidebar-panel .lens-title { font-size: 14px; margin-bottom: 8px; }

        .lens-card .card-meta {
            font-size: 12px;
            opacity: 0.7;
            display: none; 
        }

        .sidebar-panel .lens-card .card-meta { display: block; }

        /* --- ARTIFACTS PANEL --- */
        .artifacts-panel {
            display: none;
            width: 340px; 
            height: 96vh;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px; 
            overflow-y: auto;
            color: white;
        }

        body.interacting .artifacts-panel { display: flex; flex-direction: column; }

        .artifact-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }

        .artifact-card .type { font-size: 10px; font-weight: 700; color: #00D1FF; margin-bottom: 4px; }
        .artifact-card .title { font-size: 14px; font-weight: 500; margin-bottom: 8px; display: block; line-height: 1.3; }
        .artifact-card .meta { font-size: 12px; opacity: 0.7; }

        /* ARTIFACT ACTION BUTTONS */
        .artifact-btn {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .artifact-btn:hover { background: rgba(255, 255, 255, 0.3); }

        /* AUDIT SCORE STYLING */
        .audit-score-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 10px 0;
        }
        .score-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #00D1FF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        /* SERVICENOW SPECIFIC BUTTON */
        .sn-btn {
            background: #8F29FC !important;
            border: none;
        }

        /* --- CHAT CONTAINER --- */
        .chat-container {
            width: 100%; 
            background: transparent; 
            height: 160px; 
            border-radius: 8px; 
            overflow: visible; 
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; 
            flex-grow: 0;
        }

        body.interacting .chat-container { 
            flex-grow: 1; 
            height: 96vh; 
            background: #ffffff; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden; 
        }

        .chat-header-lintel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, #ffffff 60%, rgba(255, 255, 255, 0) 100%);
            z-index: 45;
            pointer-events: none;
            display: none;
        }
        body.interacting .chat-header-lintel { display: block; }

        .chat-history {
            flex-grow: 1;
            padding: 60px 30px 180px 30px; 
            overflow-y: auto;
            display: none; 
            background: white; 
        }

        body.interacting .chat-history { display: flex; flex-direction: column; }

        /* --- CHAT INPUT AREA --- */
        .chat-input-area {
            position: absolute;
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%);
            width: 710px !important; 
            display: flex;
            flex-direction: column; 
            padding: 20px 30px 15px 30px;
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 32px; 
            box-shadow: 0 12px 40px rgba(0,0,0,0.15); 
            z-index: 50;
        }

        textarea { 
            background: transparent; 
            border: none; 
            color: #1F1F1F; 
            font-size: 16px; 
            outline: none; 
            resize: none; 
            margin-bottom: 10px;
            max-height: 200px; 
            overflow-y: auto; 
            line-height: 1.5;
            display: block;
            width: 100%;
        }

        /* SECURE MODE CSS */
        .secure-mask {
            -webkit-text-security: disc !important;
        }

        .icon-btn.secure-active {
            color: #0079FF !important;
        }

        /* --- SELECTOR PILLS & DROPDOWNS --- */
        .selector-pill {
            background: #F0F4F9;
            color: #444746;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
            user-select: none;
            position: relative; 
        }
        .selector-pill:hover { background: #E3E8EF; }

        #jobFamilyValue {
            transition: color 0.2s;
        }

        .dropdown-menu {
            position: absolute;
            bottom: calc(100% + 12px);
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
            min-width: 200px;
            display: none;
            flex-direction: column;
            padding: 8px 0;
            z-index: 100;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dropdown-menu.active { display: flex; }

        .dropdown-item {
            padding: 10px 20px;
            font-size: 14px;
            color: #1F1F1F;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dropdown-item:hover { background: #F8F9FA; }

        /* --- MESSAGES --- */
        .msg { margin-bottom: 30px; font-size: 16px; line-height: 1.6; color: #1F1F1F; width: 100%; }
        
        .msg.you { display: flex; flex-direction: column; align-items: flex-end; text-align: right; }
        .msg.you .msg-bubble-container { display: flex; align-items: flex-start; gap: 8px; flex-direction: row-reverse; max-width: 65%; }
        .msg.you .msg-content { background: #F0F4F9; padding: 12px 20px; border-radius: 22px 0px 22px 22px; }
        
        .msg.ats { 
            display: flex; 
            flex-direction: row; 
            align-items: flex-start; 
            text-align: left; 
            gap: 12px; 
            padding-left: 80px; 
            padding-right: 20px; 
        }
        
        .msg-body { display: flex; flex-direction: column; width: 100%; }
        .msg.ats .msg-content { max-width: 100%; background: transparent; padding: 0; }

        .action-row {
            display: flex;
            align-items: center;
            gap: 2px; 
            margin-top: 14px;
            opacity: 1; 
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #444746;
            padding: 4px; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
            position: relative;
        }
        .action-btn:hover { background: rgba(0,0,0,0.06); color: #1F1F1F; }
        .action-btn svg { width: 18px; height: 18px; fill: currentColor; transition: color 0.2s; } 

        .action-btn.active-feedback { color: #0079FF !important; }

        .tooltip {
            position: absolute;
            bottom: -34px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c2c2c;
            color: #ffffff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1000;
            pointer-events: none;
            letter-spacing: 0.2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .action-btn:hover .tooltip, .icon-btn:hover .tooltip, .selector-pill:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transition-delay: 0.1s;
        }
        
        .msg-content ul { margin: 12px 0 12px 20px; }
        .msg-content li { margin-bottom: 8px; }
        pre.code-block {
            background: #F8F9FA; border: 1px solid #E3E8EF; border-radius: 8px; padding: 16px;
            margin: 12px 0; font-family: 'Courier New', Courier, monospace; font-size: 14px;
            overflow-x: auto; color: #1F1F1F;
        }
        .code-keyword { color: #d73a49; font-weight: 600; }
        .code-string { color: #032f62; }
        .code-comment { color: #6a737d; font-style: italic; }
        .code-func { color: #6f42c1; }

        .bot-icon { 
            flex-shrink: 0; 
            width: 26px; 
            height: 26px; 
            margin-top: 3px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .bot-icon img { width: 100%; height: 100%; filter: invert(37%) sepia(93%) saturate(3471%) hue-rotate(202deg) brightness(101%) contrast(107%); }

        .typing { display: none; margin-bottom: 20px; padding-left: 80px; align-items: center; gap: 12px; }

        .input-footer { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .footer-left, .footer-right { display: flex; align-items: center; gap: 12px; position: relative; }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: #444746; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .icon-btn:hover { background: rgba(0,0,0,0.04); }
        .icon-btn svg { width: 20px; height: 20px; }
        
        .send-btn-original { background: #D7DDE8; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .send-btn-original svg { width: 24px; height: 24px; fill: #0079FF; margin-left: 2px; }

        .send-btn-original.is-thinking svg { fill: #0079FF; width: 25px; height: 25px; margin-left: 0; }

        @keyframes subtleFadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .gemini-fade { animation: subtleFadeIn 0.5s ease forwards; }

        .thinking-wrapper { position: relative; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; }
        .thinking-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid rgba(143, 41, 252, 0.1); border-top-color: #8F29FC; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .reset-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; cursor: pointer; display: none; z-index: 60; padding: 15px; border-radius: 50%; }
        body.interacting .reset-btn { display: flex; }

        /* --- NEW MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            width: 800px;
            max-width: 90vw;
            max-height: 85vh;
            border-radius: 16px;
            box-shadow: 0 24px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #1F1F1F;
            animation: modalFadeUp 0.3s ease-out;
        }

        @keyframes modalFadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 18px; font-weight: 500; color: #002d56; }

        .modal-close {
            cursor: pointer;
            color: #444746;
            transition: color 0.2s;
        }
        .modal-close:hover { color: #000; }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .modal-footer {
            padding: 15px 30px;
            border-top: 1px solid rgba(0,0,0,0.08);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #F8F9FA;
        }

        /* Audit Table Styles */
        .audit-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .audit-table th {
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #444746;
            padding: 12px;
            border-bottom: 2px solid #F0F4F9;
        }
        .audit-table td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid #F0F4F9;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }
        .status-fail { background: #FFEBEE; color: #C62828; }
        
        .modal-util-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #E3E8EF;
            background: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        .modal-util-btn:hover { background: #F0F4F9; }
        .modal-util-btn.primary { background: #0079FF; color: white; border: none; }
        .modal-util-btn.primary:hover { background: #0062cc; }

    </style>
</head>
<body id="body">

    <div class="video-background">
        <iframe src="https://player.vimeo.com/video/1000239305?background=1&autoplay=1&loop=1&byline=0&title=0&muted=1" frameborder="0"></iframe>
    </div>
    <div class="overlay"></div>

    <nav id="navBar"><div class="nav-brand"><img src="logo.png" alt="Brambles Logo" class="logo-img"></div></nav>

    <div class="container" id="mainContainer">
        <h1>How do you want to work today?</h1>
        <p class="subtitle">Find the right analytics tools, permissions and data.</p>

        <div class="sidebar-panel" id="sidebarPanel">
            <div class="lenses-header">TRIGGER A WORKFLOW</div>
            
            <div class="lens-card" onclick="triggerChat('Find a model or feature store', this)">
                <div class="card-type">MODELS</div>
                <span class="lens-title">Find a model or feature store</span>
                <div class="card-meta">Read only</div>
            </div>

            <div class="lens-card" onclick="triggerChat('Locate code for re-use', this)">
                <div class="card-type">CODE</div>
                <span class="lens-title">Locate code for re-use</span>
                <div class="card-meta">Read only</div>
            </div>

            <div class="lens-card" onclick="triggerChat('Find data & data owners', this)">
                <div class="card-type">DATA</div>
                <span class="lens-title">Find data & data owners</span>
                <div class="card-meta">Read only</div>
            </div>

            <div class="lens-card" onclick="triggerChat('Against Brambles standards', this)">
                <div class="card-type">AUDIT YOUR REPO</div>
                <span class="lens-title">Against Brambles standards</span>
                <div class="card-meta">Outputs table of recommendations</div>
            </div>

            <div class="lens-card" onclick="triggerChat('Manage access and roles', this)">
                <div class="card-type">PERMISSIONS</div>
                <span class="lens-title">Manage access and roles</span>
                <div class="card-meta">View or request security credentials</div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-header-lintel"></div> 
            <button class="reset-btn" onclick="resetUI()">
                <svg viewBox="0 0 24 24" fill="#1F1F1F" opacity="0.7" width="20" height="20"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </button>
            <div class="chat-history" id="chatHistory">
                <div id="typingIndicator" class="typing">
                    <div class="thinking-wrapper">
                        <div class="thinking-ring"></div>
                        <div class="bot-icon"><img src="noun-ai-7305313.png" alt="ATS"></div>
                    </div>
                    <div class="msg-body"><div id="thoughtLabel" class="thought-token" style="font-size:12px;color:#1F1F1F">Thinking...</div></div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <textarea id="chatInput" placeholder="Ask ATS" onkeypress="handleEnter(event)" oninput="autoExpand(this)"></textarea>
                <div class="input-footer">
                    <div class="footer-left">
                        <button class="icon-btn">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            <span class="tooltip">Add resources</span>
                        </button>

                        <button id="secureBtn" class="icon-btn" onclick="toggleSecureMode()" title="Toggle Secure Mode">
                            <svg id="lockIcon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/>
                            </svg>
                            <span class="tooltip">Secure input mode</span>
                        </button>
                        
                        <div style="position: relative;">
                            <div id="jobFamilyPill" class="selector-pill" onclick="toggleMenu('jobFamilyMenu', event)">
                                Job Family: <span id="jobFamilyValue">Auto</span>
                                <span class="tooltip">Puts agents into selected expert mode</span>
                            </div>
                            <div id="jobFamilyMenu" class="dropdown-menu">
                                <div class="dropdown-item" onclick="selectOption('jobFamilyValue', 'Auto', 'jobFamilyMenu')">Auto</div>
                                <div class="dropdown-item" onclick="selectOption('jobFamilyValue', 'ML/Data science', 'jobFamilyMenu')">ML/Data science</div>
                                <div class="dropdown-item" onclick="selectOption('jobFamilyValue', 'Data Analysis', 'jobFamilyMenu')">Data Analysis</div>
                                <div class="dropdown-item" onclick="selectOption('jobFamilyValue', 'Data Engineering', 'jobFamilyMenu')">Data Engineering</div>
                                <div class="dropdown-item" onclick="selectOption('jobFamilyValue', 'Visualisation Engineering', 'jobFamilyMenu')">Visualisation Engineering</div>
                                <div class="dropdown-item" onclick="selectOption('jobFamilyValue', 'Process Automation', 'jobFamilyMenu')">Process Automation</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer-right">
                        <div style="position: relative;">
                            <div class="selector-pill" onclick="toggleMenu('proficiencyMenu', event)">
                                Proficiency: <span id="proficiencyValue">Auto</span>
                                <span class="tooltip">Agents moderate technical jargon based on this</span>
                            </div>
                            <div id="proficiencyMenu" class="dropdown-menu" style="right: 0;">
                                <div class="dropdown-item" onclick="selectOption('proficiencyValue', 'Auto', 'proficiencyMenu')">Auto</div>
                                <div class="dropdown-item" onclick="selectOption('proficiencyValue', 'Low code', 'proficiencyMenu')">Low code</div>
                                <div class="dropdown-item" onclick="selectOption('proficiencyValue', 'Code first', 'proficiencyMenu')">Code first</div>
                            </div>
                        </div>

                        <button id="sendBtn" class="send-btn-original" onclick="handleButtonClick()">
                            <svg id="sendIcon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#0079FF"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="artifacts-panel" id="artifactsPanel">
            <div class="artifact-header">Resources & Artifacts</div>
            
            <div class="artifact-card">
                <div class="type">REPO AUDIT</div>
                <span class="title">Security & Standards Compliance</span>
                <div class="audit-score-container">
                    <div class="score-circle">82</div>
                    <div class="meta">Satisfactory<br>3 non-compliant files</div>
                </div>
                <button class="artifact-btn" onclick="openModal('audit')">View Detailed Audit</button>
            </div>

            <div class="artifact-card">
                <div class="type">ACCESS REQUEST</div>
                <span class="title">Brambles Data Lake - Production Read</span>
                <div class="meta">Role: Data Scientist<br>ID: AD-PROD-RE-01</div>
                <a href="https://brambles.service-now.com/" target="_blank" class="artifact-btn sn-btn">Open ServiceNow Ticket</a>
            </div>

            <div class="artifact-card">
                <div class="type">DATA OWNER</div>
                <span class="title">Global Supply Chain Portfolio</span>
                <div class="meta">Owner: Sarah Jenkins<br>Tribe: Logistics Excellence</div>
                <button class="artifact-btn" onclick="openModal('contact')">Connect via Teams</button>
            </div>

            <div class="artifact-card">
                <div class="type">DOCUMENTATION</div>
                <span class="title">Azure Databricks Setup Guide</span>
                <div class="meta">PDF â€¢ 2.4 MB</div>
                <button class="artifact-btn" onclick="openModal('doc')">Open Guide</button>
            </div>
        </div>
    </div>

    <div id="atsModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div id="modalTitle" class="modal-title">Resource Detail</div>
                <div class="modal-close" onclick="closeModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </div>
            </div>
            <div id="modalBody" class="modal-body">
                </div>
            <div id="modalFooter" class="modal-footer">
                </div>
        </div>
    </div>

    <script>
        const chatHistory = document.getElementById('chatHistory');
        const typingIndicator = document.getElementById('typingIndicator');
        const thoughtLabel = document.getElementById('thoughtLabel');
        const body = document.getElementById('body');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const sendIcon = document.getElementById('sendIcon');
        const secureBtn = document.getElementById('secureBtn');
        const lockIcon = document.getElementById('lockIcon');

        const ICONS = {
            send: `<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#0079FF"></path>`,
            stop: `<rect x="6" y="6" width="12" height="12" fill="#0079FF"/>`,
            copy: `<svg viewBox="0 -960 960 960"><path d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z"/></svg>`,
            redo: `<svg viewBox="0 -960 960 960"><path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/></svg>`,
            thumbUp: `<svg viewBox="0 -960 960 960"><path d="M720-120H280v-520l280-280 50 50q7 7 11.5 19t4.5 23v14l-44 174h258q32 0 56 24t24 56v80q0 7-2 15t-4 15L794-188q-9 22-30 45t-44 23Zm-360-80h360l120-280v-80H480l54-220-174 174v406Zm0-406v406-406Zm-80-114v80H160v360h120v80H80v-520h200Z"/></svg>`,
            thumbDown: `<svg viewBox="0 -960 960 960"><path d="M240-840h440v520L400-40l-50-50q-7-7-11.5-19t-4.5-23v-14l44-174H120q-32 0-56-24t-24-56v-80q0-7 2-15t4-15l166-386q9-22 30-45t44-23Zm360 80H240L120-480v80h360l-54 220 174-174v-406Zm0 406v-406 406Zm80 114v-80h120v-360H680v-80h200v520H680Z"/></svg>`,
            thumbUpFilled: `<svg viewBox="0 -960 960 960"><path d="M200-120v-520h160v520H200Zm240 0q-33 0-56.5-23.5T360-200v-393q0-19 8.5-35t23.5-25l168-167 48 48q11 11 15.5 25t4.5 29v14l-44 174h258q33 0 56.5 23.5T920-480v80q0 8-1.5 15t-4.5 15L814-188q-10 24-31 46t-43 22H440Z"/></svg>`,
            thumbDownFilled: `<svg viewBox="0 -960 960 960"><path d="M760-840v520H600v-520h160Zm-240 0q33 0 56.5 23.5T600-760v393q0 19-8.5 35t-23.5 25L400-140l-48-48q-11-11-15.5-25t-4.5-29v-14l44-174H120q-33 0-56.5-23.5T40-480v-80q0-8 1.5-15t4.5-15l100-202q10-24 31-46t43-22h300Z"/></svg>`,
            locked: `<path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/>`,
            unlocked: `<path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/>`,
            visibility: `<svg viewBox="0 -960 960 960"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-80q-42 0-71-29t-29-71q0-42 29-71t71-29q42 0 71 29t29 71q0 42-29 71t-71 29Zm0 240q-171 0-313-88T20-500q71-152 213-240t313-88q171 0 313 88t147 240q-71 152-213 240t-313 88Zm0-80q139 0 257.5-70.5T873-500q-65-112-183.5-182.5T480-753q-139 0-257.5 70.5T39-500q65 112 183.5 182.5T480-247Z"/></svg>`,
            visibilityOff: `<svg viewBox="0 -960 960 960"><path d="m644-428-58-58q9-47-27-83t-83-27l-58-58q17-8 37-12t40-4q75 0 127.5 52.5T660-500q0 20-4 40t-12 37ZM480-200q-151 0-285.5-73.5T20-480q38-84 104-149.5T275-739l57 57q-51 27-94.5 67.5T163-500q56 93 151 146.5T480-300q26 0 51.5-4.5T581-319l61 61q-38 18-79 28t-83 10Zm366-20L718-348q36-19 68-43.5t61-55.5q-56-93-151-146.5T480-647q-28 0-54.5 4.5T372-629L242-759q48-18 114-29.5T480-800q171 0 313 88t147 240q-26 56-65 105.5T846-220Zm-114-10L148-814l56-56 586 586-56 56Z"/></svg>`
        };

        let isSecureMode = false;
        let isThinking = false;
        let stopThinking = false;
        let lastUserMessage = "";
        const dummyThoughts = ["Scanning stack...", "Checking governance...", "Finalizing..."];

        const jobFamilyTextColors = {
            'Auto': '#444746',
            'ML/Data science': '#FF8800',
            'Data Analysis': '#0079FF',
            'Data Engineering': '#8F29FC',
            'Visualisation Engineering': '#677447',
            'Process Automation': '#AD5321'
        };

        function toggleSecureMode() {
            isSecureMode = !isSecureMode;
            chatInput.classList.toggle('secure-mask', isSecureMode);
            secureBtn.classList.toggle('secure-active', isSecureMode);
            lockIcon.innerHTML = isSecureMode ? ICONS.locked : ICONS.unlocked;
            chatInput.focus();
        }

        function toggleMenu(menuId, event) {
            event.stopPropagation();
            const menu = document.getElementById(menuId);
            const isActive = menu.classList.contains('active');
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
            if (!isActive) menu.classList.add('active');
        }

        function selectOption(targetId, value, menuId) {
            const labelSpan = document.getElementById(targetId);
            labelSpan.innerText = value;
            document.getElementById(menuId).classList.remove('active');
            chatInput.focus();

            if (targetId === 'jobFamilyValue') {
                labelSpan.style.color = jobFamilyTextColors[value] || '#444746';
                body.classList.add('interacting');
                simulateThinking(`Understood. I have optimized your analytics workbench for **${value}** standards.`);
            }
            
            if (targetId === 'proficiencyValue') {
                body.classList.add('interacting');
                simulateThinking(`Acknowledge: Switching tooling recommendations to **${value}** mode.`);
            }
        }

        window.onclick = function() {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('active'));
        };

        function handleButtonClick() { 
            if (isThinking) { 
                stopThinking = true; 
            } else { 
                sendUserMessage(); 
            } 
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalColor = btn.style.color;
                btn.style.color = '#1a73e8';
                setTimeout(() => btn.style.color = originalColor, 1000);
            });
        }

        function copyText(btn) {
            const container = btn.closest('.msg-body') || btn.closest('.msg-bubble-container');
            const content = container.querySelector('.msg-content').innerText;
            copyToClipboard(content, btn);
        }

        function toggleReveal(btn) {
            const container = btn.closest('.msg-bubble-container');
            const content = container.querySelector('.msg-content');
            const isMaskedNow = content.classList.toggle('secure-mask');
            btn.innerHTML = (isMaskedNow ? ICONS.visibility : ICONS.visibilityOff) + `<span class="tooltip">${isMaskedNow ? 'Reveal text' : 'Hide text'}</span>`;
        }

        function handleFeedback(btn, type) {
            const row = btn.parentElement;
            const upBtn = row.querySelector('.thumb-up-btn');
            const downBtn = row.querySelector('.thumb-down-btn');
            if (type === 'up') {
                downBtn.classList.remove('active-feedback');
                downBtn.innerHTML = ICONS.thumbDown + '<span class="tooltip">Bad response</span>';
                const isActive = btn.classList.toggle('active-feedback');
                btn.innerHTML = (isActive ? ICONS.thumbUpFilled : ICONS.thumbUp) + '<span class="tooltip">Good response</span>';
            } else {
                upBtn.classList.remove('active-feedback');
                upBtn.innerHTML = ICONS.thumbUp + '<span class="tooltip">Good response</span>';
                const isActive = btn.classList.toggle('active-feedback');
                btn.innerHTML = (isActive ? ICONS.thumbDownFilled : ICONS.thumbDown) + '<span class="tooltip">Bad response</span>';
            }
        }

        async function simulateThinking(finalText) {
            isThinking = true;
            stopThinking = false;
            typingIndicator.style.display = 'flex';
            sendBtn.classList.add('is-thinking');
            sendIcon.innerHTML = ICONS.stop;
            chatHistory.scrollTop = chatHistory.scrollHeight;

            for (const thought of dummyThoughts) {
                if (stopThinking) break;
                thoughtLabel.innerText = thought;
                await new Promise(r => setTimeout(r, 400)); 
            }

            if (stopThinking) {
                addMessage("Request stopped", 'ATS');
            } else {
                addMessage(finalText, 'ATS');
            }

            typingIndicator.style.display = 'none';
            sendBtn.classList.remove('is-thinking');
            sendIcon.innerHTML = ICONS.send;
            isThinking = false;
            stopThinking = false;
        }

        function sendUserMessage(retext = null) {
            body.classList.add('interacting');
            const text = retext || chatInput.value.trim();
            if(!text) return;
            lastUserMessage = text;
            addMessage(text, 'You', isSecureMode);
            if(!retext) {
                chatInput.value = '';
                chatInput.style.height = 'auto'; 
            }
            const response = `Based on your request, I recommend utilizing a standard Azure Databricks cluster:
            <pre class="code-block"><span class="code-keyword">import</span> databricks.koalas <span class="code-keyword">as</span> ks\ndf = ks.<span class="code-func">read_csv</span>(<span class="code-string">"dbfs:/mnt/data.csv"</span>)</pre>
            <ul><li>Scalable compute nodes.</li><li>Shared tribe workspace.</li></ul>`;
            simulateThinking(response);
        }

        function addMessage(text, sender, masked = false) {
            const div = document.createElement('div');
            div.className = `msg ${sender.toLowerCase()}`;
            const maskClass = masked ? 'secure-mask' : '';
            
            if (sender === 'ATS') { 
                div.innerHTML = `
                    <div class="bot-icon"><img src="noun-ai-7305313.png" alt="ATS"></div>
                    <div class="msg-body">
                        <div class="msg-content gemini-fade">${text}</div>
                        <div class="action-row">
                            <button class="action-btn thumb-up-btn" onclick="handleFeedback(this, 'up')">${ICONS.thumbUp}<span class="tooltip">Good response</span></button>
                            <button class="action-btn thumb-down-btn" onclick="handleFeedback(this, 'down')">${ICONS.thumbDown}<span class="tooltip">Bad response</span></button>
                            <button class="action-btn" onclick="sendUserMessage(lastUserMessage)">${ICONS.redo}<span class="tooltip">Regenerate</span></button>
                            <button class="action-btn" onclick="copyText(this)">${ICONS.copy}<span class="tooltip">Copy response</span></button>
                        </div>
                    </div>`; 
            } else { 
                const revealBtn = masked ? `<button class="action-btn" onclick="toggleReveal(this)">${ICONS.visibility}<span class="tooltip">Reveal text</span></button>` : '';
                div.innerHTML = `
                    <div class="msg-bubble-container">
                        <div class="msg-content ${maskClass}">${text}</div>
                        <div class="action-row" style="margin-top:0">
                            ${revealBtn}
                            <button class="action-btn" onclick="copyText(this)">${ICONS.copy}<span class="tooltip">Copy prompt</span></button>
                        </div>
                    </div>`; 
            }
            chatHistory.insertBefore(div, typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function triggerChat(lens, element) { 
            body.classList.add('interacting'); 
            addMessage(`Welcome! How can I help with ${lens} today?`, 'ATS'); 
            chatInput.focus();
        }

        function resetUI() { 
            body.classList.remove('interacting'); 
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }
        
        function autoExpand(el) { 
            el.style.height = 'auto'; 
            let newHeight = el.scrollHeight;
            if (newHeight > 200) {
                el.style.height = '200px';
            } else {
                el.style.height = newHeight + 'px';
            }
        }

        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); } }

        /* --- MODAL LOGIC SECTION --- */
        const modalOverlay = document.getElementById('atsModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');

        function openModal(type) {
            modalOverlay.style.display = 'flex';
            modalBody.innerHTML = '';
            modalFooter.innerHTML = '';

            if (type === 'audit') {
                modalTitle.innerText = "Repo Audit: Security & Standards Compliance";
                modalBody.innerHTML = `
                    <p style="margin-bottom: 20px; font-size: 14px; color: #444746;">The following files do not meet Brambles production-readiness standards.</p>
                    <table class="audit-table">
                        <thead>
                            <tr><th>File Path</th><th>Issue Detected</th><th>Owner</th><th>Status</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>/src/config/keys.json</td><td>Plaintext credentials</td><td>jsmith_sc</td><td><span class="status-badge status-fail">CRITICAL</span></td></tr>
                            <tr><td>/scripts/legacy_sync.py</td><td>Deprecated library (urllib)</td><td>alovelace</td><td><span class="status-badge" style="background:#FFF3E0;color:#E65100;">WARNING</span></td></tr>
                            <tr><td>/tests/stress_test.sh</td><td>Resource leak potential</td><td>alovelace</td><td><span class="status-badge status-fail">FAIL</span></td></tr>
                        </tbody>
                    </table>
                `;
                modalFooter.innerHTML = `
                    <button class="modal-util-btn" onclick="copyToClipboard('Audit Data Table...', this)">Copy Table</button>
                    <button class="modal-util-btn primary" onclick="closeModal()">Export to CSV</button>
                `;
            } else if (type === 'contact') {
                modalTitle.innerText = "Connect with Resource Owner";
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="width: 80px; height: 80px; background: #E3E8EF; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 500; color: #002d56;">SJ</div>
                        <h3 style="margin-bottom: 5px;">Sarah Jenkins</h3>
                        <p style="color: #444746; margin-bottom: 20px;">Tribe: Logistics Excellence | Global Supply Chain</p>
                        <div style="display: flex; justify-content: center; gap: 15px;">
                            <button class="modal-util-btn" style="flex: 1; justify-content: center;">Email Sarah</button>
                            <button class="modal-util-btn primary" style="flex: 1; justify-content: center; background: #464EB8;">Open Teams Chat</button>
                        </div>
                    </div>
                `;
            } else if (type === 'doc') {
                modalTitle.innerText = "Azure Databricks Setup Guide";
                modalBody.innerHTML = `
                    <div style="background: #F0F4F9; padding: 20px; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                        <h4 style="margin-bottom: 10px;">Executive Summary</h4>
                        <p>This document outlines the provisioning of clusters within the Brambles Azure environment. Follow the "Standard Production" profile for any workloads requiring Data Lake connectivity.</p>
                        <ul style="margin-top: 15px; margin-left: 20px;">
                            <li>Step 1: Authenticate via Brambles Single Sign-On.</li>
                            <li>Step 2: Request the 'AD-PROD-RE-01' role in ServiceNow.</li>
                            <li>Step 3: Mount the supply-chain-global container.</li>
                        </ul>
                    </div>
                `;
                modalFooter.innerHTML = `
                    <button class="modal-util-btn" onclick="copyToClipboard('Link: brambles-docs/databricks-guide', this)">Copy Share Link</button>
                    <button class="modal-util-btn primary" onclick="closeModal()">Download PDF</button>
                `;
            }
        }

        function closeModal() {
            modalOverlay.style.display = 'none';
        }

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
